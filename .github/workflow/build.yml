name: RisingOS 16 Build (miatoll)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install bc bison build-essential curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagick lib32ncurses5-dev lib32z1-dev libc6-dev-i386 \
          libgl1-mesa-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop openjdk-11-jdk python3 rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev ccache -y

      - name: Install repo
        run: |
          sudo curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Init RisingOS source
        run: |
          mkdir rising && cd rising
          repo init -u https://github.com/RisingOS-Revived/android -b sixteen-aosp --git-lfs
          repo sync -j$(nproc --all)

      - name: Clone device sources
        run: |
          cd rising
          git clone https://github.com/RiteshSahany/device_xiaomi_miatoll -b 16 device/xiaomi/miatoll
          git clone https://github.com/RiteshSahany/vendor_xiaomi_miatoll -b 16 vendor/xiaomi/miatoll
          git clone https://github.com/RiteshSahany/kernel_xiaomi_sm6250 -b 16.0 kernel/xiaomi/sm6250
          git clone https://github.com/RiteshSahany/hardware_xiaomi -b 16 hardware/xiaomi
          git clone https://github.com/RiteshSahany/vendor_xiaomi_miuicamera -b 16 vendor/xiaomi/miuicamera

      - name: Build ROM
        run: |
          cd rising
          . build/envsetup.sh
          lunch rising_miatoll-userdebug
          mka bacon -j$(nproc --all)

      - name: Upload ROM
        uses: actions/upload-artifact@v3
        with:
          name: RisingOS_miatoll
          path: rising/out/target/product/miatoll/*.zip
